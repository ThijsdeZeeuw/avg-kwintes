# Apply these changes to the docker-compose.yml file to fix networking issues:

# 1. Replace the network_mode: host with proper network settings for Caddy
  caddy:
    container_name: caddy
    image: docker.io/library/caddy:2-alpine
    ports:
      - "80:80"
      - "443:443"
    restart: unless-stopped
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./dashboard:/etc/caddy/dashboard:ro
      - caddy-data:/data:rw
      - caddy-config:/config:rw
    environment:
      - N8N_HOSTNAME=${N8N_HOSTNAME:-"n8n.${DOMAIN_NAME:-kwintes.cloud}"}
      - WEBUI_HOSTNAME=${WEBUI_HOSTNAME:-"openwebui.${DOMAIN_NAME:-kwintes.cloud}"}
      - FLOWISE_HOSTNAME=${FLOWISE_HOSTNAME:-"flowise.${DOMAIN_NAME:-kwintes.cloud}"}
      - OLLAMA_HOSTNAME=${OLLAMA_HOSTNAME:-"ollama.${DOMAIN_NAME:-kwintes.cloud}"}
      - SUPABASE_HOSTNAME=${SUPABASE_HOSTNAME:-"supabase.${DOMAIN_NAME:-kwintes.cloud}"}
      - SEARXNG_HOSTNAME=${SEARXNG_HOSTNAME:-"searxng.${DOMAIN_NAME:-kwintes.cloud}"}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-tddezeeuw@gmail.com}
      - TZ=${TZ:-Europe/Amsterdam}
      - DOMAIN_NAME=${DOMAIN_NAME:-kwintes.cloud}
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"
    networks:
      - monitoring

# 2. Make sure Caddy mounts the dashboard directory
  caddy:
    # Somewhere in the volumes section add:
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./caddy_data:/data
      - ./caddy_config:/config
      - ./dashboard:/etc/caddy/dashboard:ro

# 3. Add networks section at the end of the file if not already present:
networks:
  monitoring:
    driver: bridge

# 4. Update Ollama service to use the bridge network instead of host
  ollama:
    container_name: ollama
    restart: unless-stopped
    # CHANGE THIS:
    # network_mode: host
    # TO THIS:
    networks:
      - monitoring
    ports:
      - "11434:11434" 

version: '3'

# This patch file is applied to docker-compose.yml to fix Caddy configuration

services:
  # Fix n8n port conflict with Supabase
  n8n:
    ports:
      - "5678:5678"
    environment:
      - N8N_PORT=5678
      - N8N_EDITOR_BASE_URL=https://n8n.${DOMAIN_NAME:-kwintes.cloud}

  caddy:
    container_name: caddy
    image: docker.io/library/caddy:2-alpine
    ports:
      - "80:80"
      - "443:443"
    restart: unless-stopped
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./dashboard:/etc/caddy/dashboard:ro
      - caddy-data:/data:rw
      - caddy-config:/config:rw
    environment:
      - N8N_HOSTNAME=${N8N_HOSTNAME:-"n8n.${DOMAIN_NAME:-kwintes.cloud}"}
      - WEBUI_HOSTNAME=${WEBUI_HOSTNAME:-"openwebui.${DOMAIN_NAME:-kwintes.cloud}"}
      - FLOWISE_HOSTNAME=${FLOWISE_HOSTNAME:-"flowise.${DOMAIN_NAME:-kwintes.cloud}"}
      - OLLAMA_HOSTNAME=${OLLAMA_HOSTNAME:-"ollama.${DOMAIN_NAME:-kwintes.cloud}"}
      - SUPABASE_HOSTNAME=${SUPABASE_HOSTNAME:-"supabase.${DOMAIN_NAME:-kwintes.cloud}"}
      - SEARXNG_HOSTNAME=${SEARXNG_HOSTNAME:-"searxng.${DOMAIN_NAME:-kwintes.cloud}"}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-tddezeeuw@gmail.com}
      - TZ=${TZ:-Europe/Amsterdam}
      - DOMAIN_NAME=${DOMAIN_NAME:-kwintes.cloud}
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"
    networks:
      - monitoring

# Fix connection to open-webui container
open-webui:
  ports:
    - "3000:8080"

volumes:
  caddy-data:
  caddy-config: 